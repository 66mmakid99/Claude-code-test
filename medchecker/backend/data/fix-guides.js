/**
 * 의료광고 위반 수정/대처 가이드
 * 
 * 각 위반 유형별 구체적인 수정 방법과 올바른 예시 제공
 */

const fixGuides = {
  // ============================================
  // 1. 치료효과 보장 관련
  // ============================================
  effect_guarantee: {
    categoryName: '치료효과 보장',
    generalAdvice: '치료 효과를 확실하게 보장하는 표현은 의료법 위반입니다. 개인차 면책 문구를 반드시 포함하세요.',
    
    patterns: {
      // 100% 완치 보장
      'MED-EFF-001': {
        pattern: /100%\s*(완치|효과|치료|성공)/gi,
        whyViolation: '치료 효과의 확실성을 보장하는 표현으로, 환자를 현혹할 우려가 있습니다.',
        howToFix: {
          action: '"100%" 또는 "보장" 표현을 삭제하고, 면책 문구를 추가하세요.',
          steps: [
            '1. "100%" 숫자 표현 삭제',
            '2. "완치 보장", "확실한 효과" 등의 표현 수정',
            '3. "개인차가 있을 수 있습니다" 면책 문구 추가',
            '4. 가능하면 임상 근거를 명시 (예: "논문 기준 80% 환자에서 개선")',
          ],
          badExamples: [
            '100% 완치 보장',
            '확실한 치료 효과',
            '반드시 효과를 보장합니다',
            '완치될 때까지 책임집니다',
          ],
          goodExamples: [
            '많은 환자분들이 호전을 경험하셨습니다 (개인차가 있을 수 있습니다)',
            '임상 연구 결과, 약 80%의 환자에서 증상 개선이 보고되었습니다',
            '치료 효과는 개인에 따라 다를 수 있으며, 전문의와 상담이 필요합니다',
          ],
          tips: [
            '절대적 수치(100%, 완벽, 확실)는 사용하지 마세요',
            '개인차 면책 문구는 반드시 눈에 잘 보이게 표시하세요',
            '임상 근거가 있다면 출처와 함께 명시하면 신뢰도가 높아집니다',
          ],
        },
      },
      
      // 부작용 없음 보장
      'MED-EFF-004': {
        pattern: /부작용\s*(없|제로|zero|걱정\s*없)/gi,
        whyViolation: '모든 의료 시술에는 부작용 가능성이 있으며, 이를 부정하는 것은 허위 광고입니다.',
        howToFix: {
          action: '"부작용 없음" 표현을 삭제하고, 가능한 부작용과 대처 방법을 안내하세요.',
          steps: [
            '1. "부작용 없음/제로" 표현 삭제',
            '2. 예상 가능한 부작용 명시 (예: 일시적 붓기, 멍, 통증)',
            '3. 부작용 발생 시 대처 방법 안내',
            '4. "개인에 따라 부작용이 나타날 수 있습니다" 문구 추가',
          ],
          badExamples: [
            '부작용 걱정 없는 안전한 시술',
            '부작용 제로 보장',
            '100% 안전한 시술',
          ],
          goodExamples: [
            '검증된 시술이지만 개인에 따라 일시적인 붓기, 멍이 있을 수 있습니다',
            '부작용 발생 시 담당 의료진이 즉시 대응해 드립니다',
            '시술 전 충분한 상담을 통해 예상되는 부작용을 안내해 드립니다',
          ],
        },
      },
      
      // 무통증 보장
      'MED-EFF-005': {
        pattern: /(무통|통증\s*없|아프지\s*않)/gi,
        whyViolation: '통증의 정도는 개인차가 크므로, 무통을 보장하는 것은 과장 광고입니다.',
        howToFix: {
          action: '"무통" 표현을 "통증 최소화" 또는 "통증 완화" 표현으로 수정하세요.',
          badExamples: [
            '무통 시술',
            '전혀 아프지 않습니다',
            '통증 제로',
          ],
          goodExamples: [
            '통증을 최소화하기 위해 마취 크림을 사용합니다',
            '개인에 따라 약간의 불편감이 있을 수 있으나, 대부분 참을 수 있는 수준입니다',
            '진통 관리를 통해 시술 중 불편함을 줄이기 위해 노력합니다',
          ],
        },
      },
    },
  },

  // ============================================
  // 2. 전후사진 관련
  // ============================================
  before_after: {
    categoryName: '전후사진',
    generalAdvice: '전후사진 게시 시 동일 조건 촬영, 환자 동의, 부작용 명시가 필수입니다.',
    
    patterns: {
      'MED-BA-001': {
        whyViolation: '전후사진은 치료효과를 오인하게 할 수 있어 엄격한 기준이 적용됩니다.',
        howToFix: {
          action: '전후사진 게시 시 아래 조건을 모두 충족해야 합니다.',
          steps: [
            '1. 환자의 서면 동의 획득 (개인정보 동의서)',
            '2. 전/후 사진이 동일인임을 확인할 수 있도록 표시',
            '3. 촬영 시기 명시 (예: 시술 전 / 시술 후 3개월)',
            '4. 동일 조건 촬영 (조명, 각도, 화장 상태)',
            '5. 부작용 정보 함께 표기',
            '6. 사진 보정 금지 (필터, 포토샵 등)',
          ],
          badExamples: [
            '전후 사진에서 조명/화장이 다른 경우',
            '촬영 시기가 명시되지 않은 경우',
            '부작용 정보 없이 효과만 강조한 경우',
            '환자 동의 없이 게시한 경우',
          ],
          goodExamples: [
            '[시술 전] 2024.01.01 / [시술 후 3개월] 2024.04.01 (동일 조건 촬영, 환자 동의 획득)',
            '※ 시술 후 일시적인 붓기, 멍이 있을 수 있으며 개인차가 있습니다.',
            '※ 본 사진은 환자분의 동의 하에 게시되었습니다.',
          ],
          requiredNotices: [
            '환자 동의 표시',
            '촬영 일자 표시',
            '부작용 고지',
            '개인차 면책 문구',
          ],
        },
      },
    },
  },

  // ============================================
  // 3. 과대/허위 광고 관련
  // ============================================
  exaggeration: {
    categoryName: '과대/허위 광고',
    generalAdvice: '객관적 근거 없는 최상급 표현이나 배타적 표현은 금지됩니다.',
    
    patterns: {
      'MED-EX-001': {
        pattern: /(국내\s*최초|세계\s*최초|업계\s*1위|국내\s*최고|유일)/gi,
        whyViolation: '최상급/배타적 표현은 객관적 증명이 어렵고 소비자를 오인시킬 수 있습니다.',
        howToFix: {
          action: '최상급 표현을 삭제하거나, 공인된 근거가 있는 경우에만 출처와 함께 사용하세요.',
          steps: [
            '1. "최초", "최고", "1위", "유일" 등의 표현 삭제',
            '2. 공인 기관 인증이 있다면 인증 내용과 출처 명시',
            '3. 객관적 수치로 대체 (예: "10년 경력" 대신 "2014년 개원")',
          ],
          badExamples: [
            '국내 최고의 피부과',
            '업계 1위 성형외과',
            '유일한 치료법',
            '세계 최초 도입',
          ],
          goodExamples: [
            '2014년 개원, 10년간 5만 케이스 진료',
            'OO 인증 전문병원 (보건복지부 지정)',
            '최신 장비를 도입하여 진료하고 있습니다',
          ],
          allowedIfProven: [
            '보건복지부 지정 전문병원인 경우 "보건복지부 지정" 명시',
            '공인 기관 평가 순위가 있는 경우 출처와 함께 명시',
            '특허/인증이 있는 경우 인증번호와 함께 명시',
          ],
        },
      },
    },
  },

  // ============================================
  // 4. 유명인/추천 광고 관련
  // ============================================
  celebrity: {
    categoryName: '유명인 추천',
    generalAdvice: '유명인을 이용한 추천/보증 광고는 전면 금지됩니다.',
    
    patterns: {
      'MED-CL-001': {
        pattern: /(연예인|배우|가수|인플루언서|셀럽|유명인)\s*(추천|이용|다니는|선택)/gi,
        whyViolation: '유명인을 이용한 추천/보증은 의료법에서 금지하고 있습니다.',
        howToFix: {
          action: '유명인 관련 표현을 모두 삭제하세요. 대안으로 전문의 경력이나 학술 성과를 강조할 수 있습니다.',
          steps: [
            '1. 유명인 이름, 직업 등 모든 언급 삭제',
            '2. "연예인이 다니는", "셀럽 병원" 등 암시 표현 삭제',
            '3. 전문의 경력, 학술 논문, 학회 활동 등으로 대체',
          ],
          badExamples: [
            '연예인 OOO도 다니는 병원',
            '셀럽들의 선택',
            '유명인 추천 피부과',
            'OOO 작품에 출연한 배우가 방문한 병원',
          ],
          goodExamples: [
            '피부과 전문의 원장 직접 진료',
            '대한피부과학회 정회원',
            'SCI 논문 다수 게재',
            '10년 경력의 전문의가 진료합니다',
          ],
        },
      },
    },
  },

  // ============================================
  // 5. 가격/할인 관련
  // ============================================
  price_discount: {
    categoryName: '가격/할인',
    generalAdvice: '비급여 진료비 할인은 대상/기간/범위를 명확히 해야 합니다. 허위 할인은 환자유인에 해당할 수 있습니다.',
    
    patterns: {
      'MED-PR-001': {
        pattern: /(무료\s*(시술|상담|검진)|[0-9]+%\s*할인|파격\s*할인|특가)/gi,
        whyViolation: '불명확한 할인 광고는 소비자를 오인시키고 환자유인에 해당할 수 있습니다.',
        howToFix: {
          action: '할인 광고 시 대상, 기간, 범위, 원가를 명확히 표시하세요.',
          steps: [
            '1. 할인 전 원가 명시 (실제 정가 기준)',
            '2. 할인 대상 명확히 (예: 신규 환자 한정)',
            '3. 할인 기간 명시 (예: 2024년 1월 한정)',
            '4. 적용 시술 범위 명시',
            '5. 할인율이 과도하지 않도록 (의료시장 질서 고려)',
          ],
          badExamples: [
            '무조건 50% 할인',
            '파격 특가 이벤트',
            '무료 시술 제공',
            '선착순 할인',
          ],
          goodExamples: [
            '신규 환자 첫 방문 시 상담 비용 면제 (2024년 1월 한정)',
            '정가 50만원 → 45만원 (10% 할인, 12월 31일까지)',
            '학생 할인: 신분증 확인 시 10% 할인 적용',
          ],
          requiredDisclosures: [
            '할인 전 원가',
            '할인 대상',
            '할인 기간',
            '적용 범위',
          ],
        },
      },
    },
  },

  // ============================================
  // 6. 바이럴/체험단 관련
  // ============================================
  viral_marketing: {
    categoryName: '바이럴/체험단',
    generalAdvice: '대가성 후기는 경제적 이해관계를 반드시 표시해야 합니다. 허위 후기 작성은 금지됩니다.',
    
    patterns: {
      'MED-SNS-001': {
        pattern: /(체험단|협찬|무료\s*제공|원고료)/gi,
        whyViolation: '경제적 이해관계를 표시하지 않은 대가성 후기는 기만적 광고에 해당합니다.',
        howToFix: {
          action: '경제적 이해관계를 명확히 표시하고, 치료효과 오인 표현을 삭제하세요.',
          steps: [
            '1. 게시물 상단에 "광고", "협찬", "체험단" 표시',
            '2. 치료효과를 단정적으로 표현하지 않기',
            '3. 개인적 경험임을 명시',
            '4. 부작용 가능성 언급',
          ],
          badExamples: [
            '(협찬 표시 없이) 완전 좋아요! 100% 추천해요!',
            '여기서 시술 받으면 무조건 예뻐져요',
            '부작용 하나도 없었어요',
          ],
          goodExamples: [
            '[광고] 본 게시물은 소정의 원고료를 받아 작성되었습니다.',
            '개인적인 경험으로, 효과는 개인에 따라 다를 수 있습니다.',
            '시술 후 약간의 붓기가 있었으나 일주일 내 호전되었습니다.',
          ],
          requiredDisclosures: [
            '광고/협찬 표시 (게시물 상단 또는 제목에)',
            '경제적 이해관계 명시',
            '개인 경험임을 명시',
          ],
        },
      },
    },
  },
};

/**
 * 규칙 ID로 수정 가이드 조회
 */
function getFixGuide(ruleId) {
  for (const category of Object.values(fixGuides)) {
    if (category.patterns && category.patterns[ruleId]) {
      return {
        categoryName: category.categoryName,
        generalAdvice: category.generalAdvice,
        ...category.patterns[ruleId].howToFix,
        whyViolation: category.patterns[ruleId].whyViolation,
      };
    }
  }
  return null;
}

/**
 * 카테고리로 수정 가이드 조회
 */
function getFixGuideByCategory(categoryName) {
  const category = fixGuides[categoryName];
  if (category) {
    return {
      categoryName: category.categoryName,
      generalAdvice: category.generalAdvice,
      patterns: Object.entries(category.patterns || {}).map(([id, p]) => ({
        ruleId: id,
        ...p.howToFix,
        whyViolation: p.whyViolation,
      })),
    };
  }
  return null;
}

/**
 * 모든 카테고리 목록
 */
function getAllCategories() {
  return Object.entries(fixGuides).map(([key, value]) => ({
    key,
    name: value.categoryName,
    generalAdvice: value.generalAdvice,
  }));
}

module.exports = {
  fixGuides,
  getFixGuide,
  getFixGuideByCategory,
  getAllCategories,
};
