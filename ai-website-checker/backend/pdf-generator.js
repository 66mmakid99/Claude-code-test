const PDFDocument = require('pdfkit');
const fs = require('fs');
const path = require('path');

function generatePDFReport(results, outputPath) {
  return new Promise((resolve, reject) => {
    try {
      // Create a document
      const doc = new PDFDocument({ margin: 50 });

      // Pipe to a file
      const stream = fs.createWriteStream(outputPath);
      doc.pipe(stream);

      // Add title
      doc
        .fontSize(24)
        .fillColor('#667eea')
        .text('AI Website Checker Report', { align: 'center' })
        .moveDown();

      // Add URL and timestamp
      doc
        .fontSize(12)
        .fillColor('#333333')
        .text(`Website: ${results.url}`, { align: 'center' })
        .text(`Analysis Date: ${new Date(results.timestamp).toLocaleString()}`, { align: 'center' })
        .moveDown(2);

      // Overall Score Section
      doc
        .fontSize(18)
        .fillColor('#667eea')
        .text('Overall Score', { underline: true })
        .moveDown(0.5);

      const scoreColor = getScoreColor(results.score);
      const scoreLabel = getScoreLabel(results.score);

      doc
        .fontSize(48)
        .fillColor(scoreColor)
        .text(`${results.score}`, { align: 'center' })
        .fontSize(14)
        .fillColor('#666666')
        .text(`out of ${results.maxScore}`, { align: 'center' })
        .fontSize(18)
        .fillColor(scoreColor)
        .text(scoreLabel, { align: 'center' })
        .moveDown(2);

      // Detailed Analysis
      doc
        .fontSize(18)
        .fillColor('#667eea')
        .text('Detailed Analysis', { underline: true })
        .moveDown(1);

      // Iterate through each check category
      Object.values(results.checks).forEach((check, index) => {
        // Category title
        doc
          .fontSize(14)
          .fillColor('#333333')
          .text(check.category, { continued: false })
          .moveDown(0.3);

        // Score
        const categoryScoreColor = getScoreColor((check.score / check.maxScore) * 100);
        doc
          .fontSize(12)
          .fillColor(categoryScoreColor)
          .text(`Score: ${check.score} / ${check.maxScore}`)
          .moveDown(0.5);

        // Issues
        if (check.issues.length > 0) {
          doc
            .fontSize(11)
            .fillColor('#d32f2f')
            .text('Issues Found:', { underline: true })
            .moveDown(0.2);

          check.issues.forEach(issue => {
            doc
              .fontSize(10)
              .fillColor('#666666')
              .text(`  • ${issue}`, { indent: 20 })
              .moveDown(0.1);
          });
          doc.moveDown(0.3);
        }

        // Recommendations
        if (check.recommendations.length > 0) {
          doc
            .fontSize(11)
            .fillColor('#1976d2')
            .text('Recommendations:', { underline: true })
            .moveDown(0.2);

          check.recommendations.forEach(rec => {
            doc
              .fontSize(10)
              .fillColor('#666666')
              .text(`  • ${rec}`, { indent: 20 })
              .moveDown(0.1);
          });
        }

        doc.moveDown(1.5);

        // Add page break if needed (except for last item)
        if (index < Object.values(results.checks).length - 1 && doc.y > 650) {
          doc.addPage();
        }
      });

      // Footer
      doc
        .fontSize(10)
        .fillColor('#999999')
        .text(
          'Generated by AI Website Checker v1.0',
          50,
          doc.page.height - 50,
          { align: 'center' }
        );

      // Finalize PDF
      doc.end();

      stream.on('finish', () => {
        resolve(outputPath);
      });

      stream.on('error', (err) => {
        reject(err);
      });

    } catch (error) {
      reject(error);
    }
  });
}

function getScoreColor(score) {
  if (score >= 80) return '#4caf50';
  if (score >= 60) return '#ff9800';
  return '#f44336';
}

function getScoreLabel(score) {
  if (score >= 80) return 'Excellent';
  if (score >= 60) return 'Good';
  if (score >= 40) return 'Fair';
  return 'Needs Improvement';
}

module.exports = {
  generatePDFReport
};
